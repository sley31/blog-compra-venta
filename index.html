<!doctype html>





  

  

  Compra & Venta CR — Publicaciones

  <style>

    :root{ --maxw:760px; --accent:#0b72ff; --card:#fff; --muted:#6b7280; }

    body{ font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f6f7fa; color:#111; padding:18px; display:flex; justify-content:center;}

    .wrap{ width:100%; max-width:var(--maxw); }

    header{ display:flex; gap:10px; align-items:center; margin-bottom:14px;}

    header h1{ font-size:1.1rem; margin:0; }

    .btn{ background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }

    .btn.ghost{ background:transparent; border:1px solid #e6e9ef; color:inherit; }

    .card{ background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(15,23,42,0.04); margin-bottom:12px; border:1px solid #eef2f7; }

    .row{ display:flex; gap:8px; margin-bottom:8px; }

    input[type="text"], textarea{ width:100%; padding:8px; border-radius:8px; border:1px solid #e6e9ef; background:#fff; box-sizing:border-box; }

    textarea{ min-height:90px; resize:vertical; }

    .posts-wrap{ max-height:520px; overflow:auto; padding:6px; display:flex; flex-direction:column; gap:12px; }

    .post{ padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid #eef2f7; }

    .post h3{ margin:0 0 6px 0; font-size:1rem; font-weight:800; }

    .meta{ font-size:0.82rem; color:var(--muted); margin-bottom:8px; }

    .image-grid{ column-count: 3; column-gap:6px; }

    .image-grid img{ width:100%; display:block; margin-bottom:6px; border-radius:6px; }

    .comment-box{ margin-top:10px; border-top:1px dashed #eef2f7; padding-top:8px; }

    .comment{ background:#f2f4f8; padding:8px; border-radius:8px; margin-bottom:6px; position:relative; }

    .small{ font-size:0.85rem; color:var(--muted); }

    .right{ margin-left:auto; }

    .danger{ color:#c0392b; cursor:pointer; background:transparent; border:0; padding:4px 8px; border-radius:6px; }

    .hidden{ display:none !important; }

    @media (max-width:640px){ .image-grid{ column-count:2; } }

    @media (max-width:420px){ .image-grid{ column-count:1; } }

  </style>





  <div class="wrap">

    <header>

      <h1>Compra & Venta en Costa Rica — Publicaciones</h1>

      <div class="right">

        <button id="loginBtn" class="btn">Iniciar con Google</button>

        <button id="logoutBtn" class="btn ghost hidden">Cerrar sesión</button>

      </div>

    </header>



    <div id="userInfo" class="card hidden"></div>



    <div id="composerCard" class="card hidden" aria-live="polite">

      <h3>Crear nuevo anuncio</h3>

      <div class="row">

        <input id="title" type="text" placeholder="Título (ej. Se vende bicicleta)" />

      </div>

      <div class="row">

        <textarea id="description" placeholder="Descripción, condición, detalles..."></textarea>

      </div>

      <div class="row">

        <input id="price" type="text" placeholder="Precio (opcional)" />

        <input id="category" type="text" placeholder="Categoría (ej. bicis, celulares)" />

      </div>

      <div class="row">

        <input id="imagesInput" type="file" accept="image/*" multiple />

      </div>

      <div class="row">

        <button id="publishBtn" class="btn">Publicar anuncio</button>

        <button id="clearBtn" class="btn ghost">Limpiar</button>

        <div class="small right">Imágenes se suben y se guardan en Supabase Storage</div>

      </div>

    </div>



    <div class="card">

      <h3>Publicaciones</h3>

      <div id="posts" class="posts-wrap" aria-live="polite"></div>

    </div>

  </div>



  <!-- Supabase -->

  <script type="module">

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js'



    // ==== CONFIG: TU PROYECTO ====

    const SUPABASE_URL = 'https://vvfngtnslembyrwkbsnz.supabase.co';

    const SUPABASE_KEY = 'sb_publishable_1rveikhUuFfo8DjBOgBoqg_2qKATYw-'; 

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const BUCKET = 'imagenes'; // Bucket público



    // Elements

    const loginBtn = document.getElementById('loginBtn');

    const logoutBtn = document.getElementById('logoutBtn');

    const publishBtn = document.getElementById('publishBtn');

    const clearBtn = document.getElementById('clearBtn');

    const composerCard = document.getElementById('composerCard');

    const userInfo = document.getElementById('userInfo');

    const postsWrap = document.getElementById('posts');



    let sessionUser = null;



    async function init() {

      const { data } = await supabase.auth.getSession();

      sessionUser = data.session ? data.session.user : null;

      updateUI();

      await loadPosts();

      subscribePosts();

    }

    init();



    // Auth

    loginBtn.addEventListener('click', async () => {

      await supabase.auth.signInWithOAuth({ provider: 'google' });

    });

    logoutBtn.addEventListener('click', async () => {

      await supabase.auth.signOut();

      location.reload();

    });

    supabase.auth.onAuthStateChange((event, session) => {

      sessionUser = session ? session.user : null;

      updateUI();

    });



    function updateUI(){

      if(sessionUser){

        loginBtn.classList.add('hidden');

        logoutBtn.classList.remove('hidden');

        composerCard.classList.remove('hidden');

        userInfo.classList.remove('hidden');

        userInfo.innerHTML = `<div class="small"><strong>${sessionUser.user_metadata.full_name || sessionUser.email}</strong> — ${sessionUser.email}</div>`;

      } else {

        loginBtn.classList.remove('hidden');

        logoutBtn.classList.add('hidden');

        composerCard.classList.add('hidden');

        userInfo.classList.add('hidden');

      }

    }



    async function uploadImages(files){

      if(!files || files.length === 0) return [];

      const uploads = [];

      for (const file of files) {

        const fname = `posts/${sessionUser.id}/${Date.now()}_${file.name.replace(/\s/g,'_')}`;

        const { data, error } = await supabase.storage.from(BUCKET).upload(fname, file, { cacheControl: '3600', upsert: false });

        if (error) { console.error('Error subiendo:', error); continue; }

        const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(data.path);

        uploads.push(pub.publicUrl);

      }

      return uploads;

    }



    publishBtn.addEventListener('click', async () => {

      if(!sessionUser) return alert('Inicia sesión con Google para publicar.');

      const title = document.getElementById('title').value.trim();

      const description = document.getElementById('description').value.trim();

      const price = document.getElementById('price').value.trim();

      const category = document.getElementById('category').value.trim();

      const files = document.getElementById('imagesInput').files;

      if(!title || !description) return alert('Completa título y descripción.');



      publishBtn.disabled = true;

      publishBtn.textContent = 'Subiendo...';



      const images = await uploadImages(files);



      const { data, error } = await supabase.from('posts').insert([{

        user_id: sessionUser.id,

        title,

        description,

        price,

        category,

        images

      }]).select().single();



      publishBtn.disabled = false;

      publishBtn.textContent = 'Publicar anuncio';



      if(error){ console.error('Error insert:', error); return alert('Error publicando.'); }



      document.getElementById('title').value = '';

      document.getElementById('description').value = '';

      document.getElementById('price').value = '';

      document.getElementById('category').value = '';

      document.getElementById('imagesInput').value = null;



      postsWrap.scrollTop = 0;

      await loadPosts();

    });



    clearBtn.addEventListener('click', () => {

      document.getElementById('title').value = '';

      document.getElementById('description').value = '';

      document.getElementById('price').value = '';

      document.getElementById('category').value = '';

      document.getElementById('imagesInput').value = null;

    });



    async function loadPosts() {

      const { data, error } = await supabase

        .from('posts')

        .select('id, user_id, title, description, price, category, images, created_at')

        .order('created_at', { ascending: false });

      if(error){ console.error(error); return; }

      renderPosts(data || []);

    }



    function renderPosts(posts) {

      postsWrap.innerHTML = '';

      if(!posts || posts.length===0){ postsWrap.innerHTML = '<div class="small">No hay publicaciones aún.</div>'; return; }



      posts.forEach(p=>{

        const postEl = document.createElement('div'); postEl.className='post card';

        const title = document.createElement('h3'); title.textContent = p.title || '(Sin título)'; postEl.appendChild(title);

        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${p.category || ''} • ${p.price ? '₡ '+p.price : ''} • ${new Date(p.created_at).toLocaleString()}`; postEl.appendChild(meta);

        const desc = document.createElement('div'); desc.textContent = p.description || ''; postEl.appendChild(desc);



        if(p.images && p.images.length){

          const grid = document.createElement('div'); grid.className='image-grid';

          p.images.forEach(url=>{ const img=document.createElement('img'); img.src=url; grid.appendChild(img); });

          postEl.appendChild(grid);

        }



        if(sessionUser && sessionUser.id===p.user_id){

          const del = document.createElement('button'); del.className='danger'; del.textContent='Eliminar anuncio';

          del.onclick=async()=>{ if(!confirm('Eliminar este anuncio?')) return; await supabase.from('posts').delete().eq('id',p.id); loadPosts(); };

          postEl.appendChild(del);

        }



        postsWrap.appendChild(postEl);

      });

    }



    function subscribePosts(){

      supabase.channel('public:posts')

        .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload=>{ loadPosts(); })

        .subscribe();

    }

  </script>



</!doctype>